<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <title>CΛEL — Admin</title>

  <link rel="stylesheet" href="assets/css/styles.css">

  <!-- App-Helper (Theme/Active Link) -->
  <script src="assets/js/app.js"></script>

  <!-- DataSource einmalig laden (damit es nach Login verfügbar ist) -->
  <script src="assets/js/data-source.js"></script>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand">
      <img class="brand-logo invert flutter" src="assets/logo.png" alt="CΛEL Logo">
      <span class="brand-title letter-spin">CΛEL</span>
    </div>
    <nav class="navlinks" aria-label="Hauptnavigation">
      <a href="index.html">Home</a>
      <a href="profile.html">Profile</a>
      <a href="disco.html">Discography</a>
      <a href="timeline.html">Timeline</a>
      <a href="player.html">Music Player</a>
      <a href="socials.html">Socials</a>
      <a href="downloads.html">Downloads</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<!-- Login-Screen (sichtbar bis Whitelist passt) -->
<section id="login-screen" class="container" style="max-width:720px;margin:2rem auto 0">
  <article class="card">
    <h2>Admin-Login</h2>
    <p class="meta">Melde dich mit deinem Account an.</p>
    <div class="bar">
      <button id="btn-google" class="btn">Mit Account anmelden</button>
    </div>
    <div id="login-msg" class="meta" style="color:#f59f85"></div>
  </article>
</section>

<!-- Admin-UI (zunächst versteckt) -->
<main id="admin-app" class="container" hidden>
  <div class="bar" style="justify-content:space-between">
    <h2 style="margin:0">Admin</h2>
    <div>
      <span id="whoami" class="meta"></span>
      <button id="btn-logout" class="btn" style="margin-left:.5rem">Abmelden</button>
    </div>
  </div>

  <p class="meta">Beiträge & Timeline-Events verwalten. (Speicher-Modus stellst du oben in den Admin-Einstellungen ein.)</p>

  <div id="tabs" class="tabs" role="tablist" style="margin-bottom:.6rem">
    <button class="tab" data-id="tab-insta">Instagram</button>
    <button class="tab" data-id="tab-fb">Facebook</button>
    <button class="tab" data-id="tab-x">X</button>
    <button class="tab" data-id="tab-tiktok">TikTok</button>
    <button class="tab" data-id="tab-events">Timeline Events</button>
  </div>

  <div id="tabviews">
    <!-- Instagram -->
    <section id="tab-insta" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">Instagram</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-insta" class="admin-list"></div>
    </section>

    <!-- Facebook -->
    <section id="tab-fb" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">Facebook</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-fb" class="admin-list"></div>
    </section>

    <!-- X -->
    <section id="tab-x" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">X</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-x" class="admin-list"></div>
    </section>

    <!-- TikTok -->
    <section id="tab-tiktok" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">TikTok</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-tiktok" class="admin-list"></div>
    </section>

    <!-- Timeline Events -->
    <section id="tab-events" hidden>
      <div class="card">
        <h3>Neues/zu bearbeitendes Event</h3>
        <input type="hidden" id="e-id">
        <div class="form-grid">
          <div><label>Datum</label><input id="e-date" type="date" required></div>
          <div><label>Titel</label><input id="e-title" required></div>
          <div><label>Typ</label>
            <select id="e-type">
              <option>Milestone</option><option>Debut</option><option>Single</option>
              <option>Mini</option><option>Album</option><option>MV</option>
              <option>Event</option><option>Other</option>
            </select>
          </div>
          <div><label>Bild-URL (optional)</label><input id="e-img"></div>
          <div class="full"><label>Notiz</label><textarea id="e-note" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="e-save">Speichern</button>
          <button class="btn" id="e-export" type="button">Export</button>
          <label class="btn"><input type="file" id="e-import" hidden>Import</label>
          <button class="btn danger" id="e-clear" type="button">Alle Custom-Events löschen</button>
        </div>
      </div>
      <h3 style="margin-top:1rem">Custom-Events</h3>
      <div id="list-events" class="admin-list"></div>
    </section>
  </div>
</main>

<!-- Firebase v10 (ESM) + Firestore-Whitelist -->
<script type="module">
  // ==== Firebase-Config ====
  const firebaseConfig = {
    apiKey: "AIzaSyAXT3mrIMnR2owxFaJFIlfvtD94B99LIXw",
    authDomain: "urlaubsplaner-c14e8.firebaseapp.com",
    projectId: "urlaubsplaner-c14e8",
    storageBucket: "urlaubsplaner-c14e8.firebasestorage.app",
    messagingSenderId: "440153496199",
    appId: "1:440153496199:web:9f865535b50ec6de69f622"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
    signInWithRedirect, getRedirectResult, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, collection, query, where, getDocs,
    setDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Initialisieren ---
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  window.firebaseAuth = auth;
  window.db = db;

  // ---- Debug: globale Fehler sichtbar machen ----
  window.addEventListener('unhandledrejection', e => {
    console.error('[Unhandled promise]', e.reason || e);
  });
  window.addEventListener('error', e => {
    console.error('[Window error]', e.error || e.message || e);
  });

  // ---- Debug: Firestore Logging-Wrapper ----
  const _getDoc = getDoc;
  const _getDocs = getDocs;
  const _setDoc = setDoc;
  const _deleteDoc = deleteDoc;

  async function getDocLogged(ref){
    const r = await _getDoc(ref);
    console.log('[FS] getDoc ←', ref.path || ref.id, 'exists=', r.exists());
    return r;
  }
  async function getDocsLogged(q){
    const r = await _getDocs(q);
    console.log('[FS] getDocs ← (query) size=', r.size);
    return r;
  }
  async function setDocLogged(ref, data, options){
    console.log('[FS] setDoc →', ref.path || ref.id, data, options||{});
    try { return await _setDoc(ref, data, options); }
    catch(e){ console.error('[FS] setDoc FAILED:', ref.path || ref.id, e); throw e; }
  }
  async function deleteDocLogged(ref){
    console.log('[FS] deleteDoc →', ref.path || ref.id);
    try { return await _deleteDoc(ref); }
    catch(e){ console.error('[FS] deleteDoc FAILED:', ref.path || ref.id, e); throw e; }
  }

  const $ = (s, r=document)=>r.querySelector(s);
  const login  = $('#login-screen');
  const appMain= $('#admin-app');
  const who    = $('#whoami');
  const msg    = $('#login-msg');
  const google = new GoogleAuthProvider();

  function gate(open, user=null){
    if(open){
      login.hidden = true; appMain.hidden = false;
      if(who && user) who.textContent = user.displayName || user.email;

      // Admin-Logik erst nach Login laden
      if (!document.getElementById('admin-boot')) {
        const s = document.createElement('script');
        s.id = 'admin-boot';
        s.type = 'module';
        s.src = 'assets/js/admin.remote.js';
        s.onload  = () => console.log('[admin] boot (module) geladen');
        s.onerror = () => {
          console.warn('[admin] Modul-Load fehlgeschlagen – versuche Classic');
          const s2 = document.createElement('script');
          s2.id  = 'admin-boot-classic';
          s2.src = 'assets/js/admin.remote.js';
          s2.onload = () => console.log('[admin] boot (classic) geladen');
          document.body.appendChild(s2);
        };
        document.body.appendChild(s);
      }
    }else{
      appMain.hidden = true; login.hidden = false;
      if(who) who.textContent = '';
    }
  }

  // --- Whitelist: erst UID-Dokument, dann E-Mail-Fallback ---
  async function isWhitelisted(user){
    const log = (...a)=>console.log("[WL]", ...a);

    // 1) UID-Dokument
    try{
      const ref  = doc(db, "Whitelist", user.uid);
      const snap = await getDocLogged(ref);
      log("UID doc:", ref.id, "exists:", snap.exists());
      if (snap.exists()) {
        const d = snap.data(); log("UID data:", d);
        return d.admin === true && (d.status ?? "approved") === "approved";
      }
    }catch(e){
      log("UID read error:", e);
      if (msg) msg.textContent = "Whitelist (UID) nicht lesbar: " + e.message;
    }

    // 2) Fallback: per E-Mail
    try{
      const q = query(
        collection(db,"Whitelist"),
        where("email","==", user.email),
        where("status","==","approved")
      );
      const r = await getDocsLogged(q);
      log("Email query size:", r.size);
      if (!r.empty) {
        const d = r.docs[0].data(); log("Email data:", d);
        return d.admin === true;
      }
    }catch(e){
      log("Email query error:", e);
      if (msg) msg.textContent = "Whitelist-Query nicht lesbar: " + e.message;
    }
    return false;
  }

  // Redirect-Result (falls Popup geblockt)
  try { await getRedirectResult(auth); } catch {}

  // Auth-State
  onAuthStateChanged(auth, async (user) => {
    console.log("Auth state:", user?.uid, user?.email);
    if(!user){ gate(false); return; }
    const ok = await isWhitelisted(user);
    if(ok) gate(true, user);
    else { gate(false); if (msg) msg.textContent = "Kein Zugriff: Account nicht freigeschaltet."; }
  });

  // Login: Popup → Fallback Redirect
  $('#btn-google')?.addEventListener('click', async () => {
    msg.textContent = '';
    try{ await signInWithPopup(auth, google); }
    catch(e){
      console.warn("Popup-Login fehlgeschlagen, versuche Redirect:", e.code);
      try{ await signInWithRedirect(auth, google); }
      catch(err){ msg.textContent = err.message; }
    }
  });

  // Logout
  $('#btn-logout')?.addEventListener('click', () => signOut(auth));

  // Für admin.remote.js & Konsole verfügbar machen (mit Logging)
  window.__fs = {
    db,
    // Documents
    doc,
    getDoc: getDocLogged,
    setDoc: setDocLogged,
    deleteDoc: deleteDocLogged,
    // Collections & Queries
    collection,
    getDocs: getDocsLogged,
    query, where,
    // Serverzeitstempel
    serverTimestamp
  };
</script>

<footer><div class="container"><small>© <span id="year"></span> CΛEL — All Rights Reserved.</small></div></footer>
<script>__applyTheme();__markActive();</script>
</body>
</html>
