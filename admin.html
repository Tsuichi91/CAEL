<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <title>CΛEL — Admin</title>

  <link rel="stylesheet" href="assets/css/styles.css">

  <!-- App Helpers (Theme, Active Link etc.) -->
  <script src="assets/js/app.js"></script>

  <!-- DataSource nur EINMAL laden (vor dem Admin-Script nach Login) -->
  <script src="assets/js/data-source.js"></script>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand">
      <img class="brand-logo invert flutter" src="assets/logo.png" alt="CΛEL Logo">
      <span class="brand-title letter-spin">CΛEL</span>
    </div>
    <nav class="navlinks" aria-label="Hauptnavigation">
      <a href="index.html">Home</a>
      <a href="profile.html">Profile</a>
      <a href="disco.html">Discography</a>
      <a href="timeline.html">Timeline</a>
      <a href="player.html">Music Player</a>
      <a href="socials.html">Socials</a>
      <a href="downloads.html">Downloads</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<!-- Login-Screen (sichtbar bis Whitelist-Check bestanden) -->
<section id="login-screen" class="container" style="max-width:720px;margin:2rem auto 0">
  <article class="card">
    <h2>Admin-Login</h2>
    <p class="meta">Melde dich mit deinem Account an.</p>
    <div class="bar"><button id="btn-google" class="btn">Mit Account anmelden</button></div>
    <div id="login-msg" class="meta" style="color:#f59f85"></div>
  </article>
</section>

<!-- Admin-UI (zunächst versteckt) -->
<main id="admin-app" class="container" hidden>
  <div class="bar" style="justify-content:space-between">
    <h2 style="margin:0">Admin</h2>
    <div>
      <span id="whoami" class="meta"></span>
      <button id="btn-logout" class="btn" style="margin-left:.5rem">Abmelden</button>
    </div>
  </div>

  <p class="meta">Beiträge & Timeline-Events verwalten. (Speicher-Modus wählst du oben in den Admin-Einstellungen.)</p>

  <div id="tabs" class="tabs" role="tablist" style="margin-bottom:.6rem">
    <button class="tab" data-id="tab-insta">Instagram</button>
    <button class="tab" data-id="tab-fb">Facebook</button>
    <button class="tab" data-id="tab-x">X</button>
    <button class="tab" data-id="tab-tiktok">TikTok</button>
    <button class="tab" data-id="tab-events">Timeline Events</button>
  </div>

  <div id="tabviews">
    <!-- Instagram -->
    <section id="tab-insta" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">Instagram</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-insta" class="admin-list"></div>
    </section>

    <!-- Facebook -->
    <section id="tab-fb" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">Facebook</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-fb" class="admin-list"></div>
    </section>

    <!-- X -->
    <section id="tab-x" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">X</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-x" class="admin-list"></div>
    </section>

    <!-- TikTok -->
    <section id="tab-tiktok" hidden>
      <div class="card">
        <h3>Neuer/zu bearbeitender Beitrag: <span id="f-platform">TikTok</span></h3>
        <input type="hidden" id="f-id">
        <div class="form-grid">
          <div><label>Nutzername</label><input id="f-user" placeholder="@cael_official"></div>
          <div><label>Avatar-URL</label><input id="f-avatar" placeholder="assets/avatar.png"></div>
          <div><label>Bild/Video-URL</label><input id="f-img" placeholder="assets/covers/veins.png"></div>
          <div class="full"><label>Text</label><textarea id="f-text" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="f-save">Speichern</button>
          <button class="btn" id="f-export" type="button">Export</button>
          <label class="btn"><input type="file" id="f-import" hidden>Import</label>
        </div>
      </div>
      <h3 style="margin-top:1rem">Beiträge</h3>
      <div id="list-tiktok" class="admin-list"></div>
    </section>

    <!-- Timeline Events -->
    <section id="tab-events" hidden>
      <div class="card">
        <h3>Neues/zu bearbeitendes Event</h3>
        <input type="hidden" id="e-id">
        <div class="form-grid">
          <div><label>Datum</label><input id="e-date" type="date" required></div>
          <div><label>Titel</label><input id="e-title" required></div>
          <div><label>Typ</label>
            <select id="e-type">
              <option>Milestone</option><option>Debut</option><option>Single</option>
              <option>Mini</option><option>Album</option><option>MV</option>
              <option>Event</option><option>Other</option>
            </select>
          </div>
          <div><label>Bild-URL (optional)</label><input id="e-img"></div>
          <div class="full"><label>Notiz</label><textarea id="e-note" rows="3"></textarea></div>
        </div>
        <div class="bar">
          <button class="btn" id="e-save">Speichern</button>
          <button class="btn" id="e-export" type="button">Export</button>
          <label class="btn"><input type="file" id="e-import" hidden>Import</label>
          <button class="btn danger" id="e-clear" type="button">Alle Custom-Events löschen</button>
        </div>
      </div>
      <h3 style="margin-top:1rem">Custom-Events</h3>
      <div id="list-events" class="admin-list"></div>
    </section>
  </div>
</main>

<!-- Firebase v10 (ESM) + Firestore-Whitelist -->
<script type="module">
  /* ====  Deine Firebase-Konfiguration einsetzen  ==== */
  const firebaseConfig = {
  apiKey: "AIzaSyAXT3mrIMnR2owxFaJFIlfvtD94B99LIXw",
  authDomain: "urlaubsplaner-c14e8.firebaseapp.com",
  projectId: "urlaubsplaner-c14e8",
  storageBucket: "urlaubsplaner-c14e8.firebasestorage.app",
  messagingSenderId: "440153496199",
  appId: "1:440153496199:web:9f865535b50ec6de69f622"
};
  /* ================================================ */

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
    signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, query, where, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  window.firebaseAuth = auth;  // falls DataSource später ein ID-Token braucht

  const $ = (s, r=document)=>r.querySelector(s);
  const login  = $('#login-screen');
  const appMain= $('#admin-app');
  const who    = $('#whoami');
  const msg    = $('#login-msg');
  const google = new GoogleAuthProvider();

  // Admin-UI zeigen/verbergen + Admin-Code erst NACH Login laden
  function gate(open, user=null){
    if(open){
      login.hidden = true; appMain.hidden = false;
      if(who && user) who.textContent = user.displayName || user.email;
      if(!document.getElementById('admin-boot')){
        const s = document.createElement('script');
        s.id = 'admin-boot';
        s.src = 'assets/js/admin.remote.js';   // Admin-Logik erst jetzt laden
        document.body.appendChild(s);
      }
    }else{
      appMain.hidden = true; login.hidden = false;
      if(who) who.textContent = '';
    }
  }

  // Whitelist-Check in Firestore (Sammlung "Whitelist", Felder: email, admin:true, status:"approved")
  async function isWhitelisted(user){
    try{
      // Wenn Doc-ID = UID ist, kannst du statt dessen getDoc(doc(db,"Whitelist",user.uid)) nutzen.
      const q = query(collection(db,"Whitelist"),
                      where("email","==", user.email),
                      where("status","==","approved"));
      const r = await getDocs(q);
      if (r.empty) return false;
      return r.docs[0].data().admin === true;
    }catch(e){ console.error(e); return false; }
  }

  onAuthStateChanged(auth, async (user) => {
    if(!user){ gate(false); return; }
    const ok = await isWhitelisted(user);
    if(ok) gate(true, user);
    else { gate(false); msg.textContent = "Kein Zugriff: Account nicht freigeschaltet."; }
  });

  // Login/Logout
  $('#btn-google')?.addEventListener('click', async () => {
    try{ await signInWithPopup(auth, google); }
    catch(e){ msg.textContent = e.message; }
  });
  $('#btn-logout')?.addEventListener('click', () => signOut(auth));

  // Sicherheitsnetz gegen Indexierung
  if(!document.querySelector('meta[name="robots"]')){
    const m=document.createElement('meta'); m.name='robots'; m.content='noindex,nofollow'; document.head.appendChild(m);
  }
</script>

<footer><div class="container"><small>© <span id="year"></span> CΛEL — All Rights Reserved.</small></div></footer>
<script>__applyTheme();__markActive();</script>
</body>
</html>
